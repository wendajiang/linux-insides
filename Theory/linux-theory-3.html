<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Inline assembly - Linux Insides</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../Booting/index.html">Booting</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Booting/linux-bootstrap-1.html">From bootloader to kernel</a></li><li class="chapter-item expanded "><a href="../Booting/linux-bootstrap-2.html">First steps in the kernel setup code</a></li><li class="chapter-item expanded "><a href="../Booting/linux-bootstrap-3.html">Video mode initialization and transition to protected mode</a></li><li class="chapter-item expanded "><a href="../Booting/linux-bootstrap-4.html">Transition to 64-bit mode</a></li><li class="chapter-item expanded "><a href="../Booting/linux-bootstrap-5.html">Kernel decompression</a></li><li class="chapter-item expanded "><a href="../Booting/linux-bootstrap-6.html">Kernel load address randomization</a></li></ol></li><li class="chapter-item expanded "><a href="../Initialization/index.html">Initialization</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Initialization/linux-initialization-1.html">First steps in the kernel</a></li><li class="chapter-item expanded "><a href="../Initialization/linux-initialization-2.html">Early interrupts handler</a></li><li class="chapter-item expanded "><a href="../Initialization/linux-initialization-3.html">Last preparations before the kernel entry point</a></li><li class="chapter-item expanded "><a href="../Initialization/linux-initialization-4.html">Kernel entry point</a></li><li class="chapter-item expanded "><a href="../Initialization/linux-initialization-5.html">Continue architecture-specific boot-time initializations</a></li><li class="chapter-item expanded "><a href="../Initialization/linux-initialization-6.html">Architecture-specific initializations, again...</a></li><li class="chapter-item expanded "><a href="../Initialization/linux-initialization-7.html">End of the architecture-specific initializations, almost...</a></li><li class="chapter-item expanded "><a href="../Initialization/linux-initialization-8.html">Scheduler initialization</a></li><li class="chapter-item expanded "><a href="../Initialization/linux-initialization-9.html">RCU initialization</a></li><li class="chapter-item expanded "><a href="../Initialization/linux-initialization-10.html">End of initialization</a></li></ol></li><li class="chapter-item expanded "><a href="../Interrupts/index.html">Interrupts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Interrupts/linux-interrupts-1.html">Introduction</a></li><li class="chapter-item expanded "><a href="../Interrupts/linux-interrupts-2.html">Start to dive into interrupts</a></li><li class="chapter-item expanded "><a href="../Interrupts/linux-interrupts-3.html">Interrupt handlers</a></li><li class="chapter-item expanded "><a href="../Interrupts/linux-interrupts-4.html">Initialization of non-early interrupt gates</a></li><li class="chapter-item expanded "><a href="../Interrupts/linux-interrupts-5.html">Implementation of some exception handlers</a></li><li class="chapter-item expanded "><a href="../Interrupts/linux-interrupts-6.html">Handling Non-Maskable interrupts</a></li><li class="chapter-item expanded "><a href="../Interrupts/linux-interrupts-7.html">Dive into external hardware interrupts</a></li><li class="chapter-item expanded "><a href="../Interrupts/linux-interrupts-8.html">Initialization of external hardware interrupts structures</a></li><li class="chapter-item expanded "><a href="../Interrupts/linux-interrupts-9.html">Softirq, Tasklets and Workqueues</a></li><li class="chapter-item expanded "><a href="../Interrupts/linux-interrupts-10.html">Last part</a></li></ol></li><li class="chapter-item expanded "><a href="../SysCall/index.html">System calls</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../SysCall/linux-syscall-1.html">Introduction to system calls</a></li><li class="chapter-item expanded "><a href="../SysCall/linux-syscall-2.html">How the Linux kernel handles a system call</a></li><li class="chapter-item expanded "><a href="../SysCall/linux-syscall-3.html">vsyscall and vDSO</a></li><li class="chapter-item expanded "><a href="../SysCall/linux-syscall-4.html">How the Linux kernel runs a program</a></li><li class="chapter-item expanded "><a href="../SysCall/linux-syscall-5.html">Implementation of the open system call</a></li><li class="chapter-item expanded "><a href="../SysCall/linux-syscall-6.html">Limits on resources in Linux</a></li></ol></li><li class="chapter-item expanded "><a href="../Timers/index.html">Timers and time management</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Timers/linux-timers-1.html">Introduction</a></li><li class="chapter-item expanded "><a href="../Timers/linux-timers-2.html">Clocksource framework</a></li><li class="chapter-item expanded "><a href="../Timers/linux-timers-3.html">The tick broadcast framework and dyntick</a></li><li class="chapter-item expanded "><a href="../Timers/linux-timers-4.html">Introduction to timers</a></li><li class="chapter-item expanded "><a href="../Timers/linux-timers-5.html">Clockevents framework</a></li><li class="chapter-item expanded "><a href="../Timers/linux-timers-6.html">x86 related clock sources</a></li><li class="chapter-item expanded "><a href="../Timers/linux-timers-7.html">Time related system calls</a></li></ol></li><li class="chapter-item expanded "><a href="../SyncPrim/index.html">Synchronization primitives</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../SyncPrim/linux-sync-1.html">Introduction to spinlocks</a></li><li class="chapter-item expanded "><a href="../SyncPrim/linux-sync-2.html">Queued spinlocks</a></li><li class="chapter-item expanded "><a href="../SyncPrim/linux-sync-3.html">Semaphores</a></li><li class="chapter-item expanded "><a href="../SyncPrim/linux-sync-4.html">Mutex</a></li><li class="chapter-item expanded "><a href="../SyncPrim/linux-sync-5.html">Reader/Writer semaphores</a></li><li class="chapter-item expanded "><a href="../SyncPrim/linux-sync-6.html">SeqLock</a></li><li class="chapter-item expanded "><div>RCU</div></li><li class="chapter-item expanded "><div>Lockdep</div></li></ol></li><li class="chapter-item expanded "><a href="../MM/index.html">Memory management</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../MM/linux-mm-1.html">Memblock</a></li><li class="chapter-item expanded "><a href="../MM/linux-mm-2.html">Fixmaps and ioremap</a></li><li class="chapter-item expanded "><a href="../MM/linux-mm-3.html">kmemcheck</a></li></ol></li><li class="chapter-item expanded "><a href="../Cgroups/index.html">Cgroups</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Cgroups/linux-cgroups-1.html">Introduction to Control Groups</a></li></ol></li><li class="chapter-item expanded "><div>SMP</div></li><li class="chapter-item expanded "><a href="../Concepts/index.html">Concepts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Concepts/linux-cpu-1.html">Per-CPU variables</a></li><li class="chapter-item expanded "><a href="../Concepts/linux-cpu-2.html">Cpumasks</a></li><li class="chapter-item expanded "><a href="../Concepts/linux-cpu-3.html">The initcall mechanism</a></li><li class="chapter-item expanded "><a href="../Concepts/linux-cpu-4.html">Notification Chains</a></li></ol></li><li class="chapter-item expanded "><a href="../DataStructures/index.html">Data Structures in the Linux Kernel</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../DataStructures/linux-datastructures-1.html">Doubly linked list</a></li><li class="chapter-item expanded "><a href="../DataStructures/linux-datastructures-2.html">Radix tree</a></li><li class="chapter-item expanded "><a href="../DataStructures/linux-datastructures-3.html">Bit arrays</a></li></ol></li><li class="chapter-item expanded "><a href="../Theory/index.html">Theory</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Theory/linux-theory-1.html">Paging</a></li><li class="chapter-item expanded "><a href="../Theory/linux-theory-2.html">Elf64</a></li><li class="chapter-item expanded "><a href="../Theory/linux-theory-3.html" class="active">Inline assembly</a></li><li class="chapter-item expanded "><div>CPUID</div></li><li class="chapter-item expanded "><div>MSR</div></li></ol></li><li class="chapter-item expanded "><div>Initial ram disk</div></li><li><ol class="section"><li class="chapter-item expanded "><div>initrd</div></li></ol></li><li class="chapter-item expanded "><a href="../Misc/index.html">Misc</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Misc/linux-misc-1.html">Linux kernel development</a></li><li class="chapter-item expanded "><a href="../Misc/linux-misc-2.html">How the kernel is compiled</a></li><li class="chapter-item expanded "><a href="../Misc/linux-misc-3.html">Linkers</a></li><li class="chapter-item expanded "><a href="../Misc/linux-misc-4.html">Program startup process in userspace</a></li><li class="chapter-item expanded "><div>Write and Submit your first Linux kernel Patch</div></li><li class="chapter-item expanded "><div>Data types in the kernel</div></li></ol></li><li class="chapter-item expanded "><a href="../KernelStructures/index.html">KernelStructures</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../KernelStructures/linux-kernelstructure-1.html">IDT</a></li></ol></li><li class="chapter-item expanded "><a href="../LINKS.html">Useful links</a></li><li class="chapter-item expanded "><a href="../contributors.html">Contributors</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Linux Insides</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/0xAX/linux-insides/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="inline-assembly"><a class="header" href="#inline-assembly">Inline assembly</a></h1>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p>While reading source code in the <a href="https://github.com/torvalds/linux">Linux kernel</a>, I often see statements like this:</p>
<pre><code class="language-C">__asm__(&quot;andq %%rsp,%0; &quot;:&quot;=r&quot; (ti) : &quot;0&quot; (CURRENT_MASK));
</code></pre>
<p>Yes, this is <a href="https://en.wikipedia.org/wiki/Inline_assembler">inline assembly</a> or in other words assembler code which is integrated in a high level programming language. In this case the high level programming language is <a href="https://en.wikipedia.org/wiki/C_%28programming_language%29">C</a>. Yes, the <code>C</code> programming language is not very high-level, but still.</p>
<p>If you are familiar with the <a href="https://en.wikipedia.org/wiki/Assembly_language">assembly</a> programming language, you may notice that <code>inline assembly</code> is not very different from normal assembler. Moreover, the special form of inline assembly which is called <code>basic form</code> is exactly the same. For example:</p>
<pre><code class="language-C">__asm__(&quot;movq %rax, %rsp&quot;);
</code></pre>
<p>or:</p>
<pre><code class="language-C">__asm__(&quot;hlt&quot;);
</code></pre>
<p>The same code (of course without <code>__asm__</code> prefix) you might see in plain assembly code. Yes, this is very similar, but not so simple as it might seem at first glance. Actually, the <a href="https://en.wikipedia.org/wiki/GNU_Compiler_Collection">GCC</a> supports two forms of inline assembly statements:</p>
<ul>
<li><code>basic</code>;</li>
<li><code>extended</code>.</li>
</ul>
<p>The basic form consists of only two things: the <code>__asm__</code> keyword and the string with valid assembler instructions. For example it may look something like this:</p>
<pre><code class="language-C">__asm__(&quot;movq    $3, %rax\t\n&quot;
        &quot;movq    %rsi, %rdi&quot;);
</code></pre>
<p>The <code>asm</code> keyword may be used in place of <code>__asm__</code>, however <code>__asm__</code> is portable whereas the <code>asm</code> keyword is a <code>GNU</code> <a href="https://gcc.gnu.org/onlinedocs/gcc/C-Extensions.html">extension</a>. In further examples I will only use the <code>__asm__</code> variant.</p>
<p>If you know assembly programming language this looks pretty familiar. The main problem is in the second form of inline assembly statements - <code>extended</code>. This form allows us to pass parameters to an assembly statement, perform <a href="https://en.wikipedia.org/wiki/Branch_%28computer_science%29">jumps</a> etc. Does not sound difficult, but requires knowledge of special rules in addition to knowledge of the assembly language. Every time I see yet another piece of inline assembly code in the Linux kernel, I need to refer to the official <a href="https://gcc.gnu.org/onlinedocs/">documentation</a> of <code>GCC</code> to remember how a particular <code>qualifier</code> behaves or what the meaning of <code>=&amp;r</code> is for example.</p>
<p>I've decided to write this part to consolidate my knowledge related to the inline assembly, as inline assembly statements are quite common in the Linux kernel and we may see them in <a href="https://github.com/0xAX/linux-insides/blob/master/SUMMARY.md">linux-insides</a> parts sometimes. I thought that it would be useful if we have a special part which contains information on more important aspects of the inline assembly. Of course you may find comprehensive information about inline assembly in the official <a href="https://gcc.gnu.org/onlinedocs/gcc/Using-Assembly-Language-with-C.html#Using-Assembly-Language-with-C">documentation</a>, but I like to put everything in one place.</p>
<p>** Note: This part will not provide guide for assembly programming. It is not intended to teach you to write programs with assembler or to know what one or another assembler instruction means. Just a little memo for extended asm. **</p>
<h2 id="introduction-to-extended-inline-assembly"><a class="header" href="#introduction-to-extended-inline-assembly">Introduction to extended inline assembly</a></h2>
<p>So, let's start. As I already mentioned above, the <code>basic</code> assembly statement consists of the <code>asm</code> or <code>__asm__</code> keyword and set of assembly instructions. This form is in no way different from &quot;normal&quot; assembly. The most interesting part is inline assembler with operands, or <code>extended</code> assembler. An extended assembly statement looks more complicated and consists of more than two parts:</p>
<pre><code class="language-assembly">__asm__ [volatile] [goto] (AssemblerTemplate
                           [ : OutputOperands ]
                           [ : InputOperands  ]
                           [ : Clobbers       ]
                           [ : GotoLabels     ]);
</code></pre>
<p>All parameters which are marked with squared brackets are optional. You may notice that if we skip the optional parameters and the modifiers <code>volatile</code> and <code>goto</code> we obtain the <code>basic</code> form.</p>
<p>Let's start to consider this in order. The first optional <code>qualifier</code> is <code>volatile</code>. This specifier tells the compiler that an assembly statement may produce <code>side effects</code>. In this case we need to prevent compiler optimizations related to the given assembly statement. In simple terms the <code>volatile</code> specifier instructs the compiler not to modify the statement and place it exactly where it was in the original code. As an example let's look at the following function from the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/arch/x86/include/asm/desc.h">Linux kernel</a>:</p>
<pre><code class="language-C">static inline void native_load_gdt(const struct desc_ptr *dtr)
{
	asm volatile(&quot;lgdt %0&quot;::&quot;m&quot; (*dtr));
}
</code></pre>
<p>Here we see the <code>native_load_gdt</code> function which loads a base address from the <a href="https://en.wikipedia.org/wiki/Global_Descriptor_Table">Global Descriptor Table</a> to the <code>GDTR</code> register with the <code>lgdt</code> instruction. This assembly statement is marked with <code>volatile</code> qualifier. It is very important that the compiler does not change the original place of this assembly statement in the resulting code. Otherwise the <code>GDTR</code> register may contain wrong address for the <code>Global Descriptor Table</code> or the address may be correct, but the structure has not been filled yet. This can lead to an exception being generated, preventing the kernel from booting correctly.</p>
<p>The second optional <code>qualifier</code> is the <code>goto</code>. This qualifier tells the compiler that the given assembly statement may perform a jump to one of the labels which are listed in the <code>GotoLabels</code>. For example:</p>
<pre><code class="language-C">__asm__ goto(&quot;jmp %l[label]&quot; : : : : label);
</code></pre>
<p>Since we finished with these two qualifiers, let's look at the main part of an assembly statement body. As we have seen above, the main part of an assembly statement consists of the following four parts:</p>
<ul>
<li>set of assembly instructions;</li>
<li>output parameters;</li>
<li>input parameters;</li>
<li>clobbers.</li>
</ul>
<p>The first represents a string which contains a set of valid assembly instructions which may be separated by the <code>\t\n</code> sequence. Names of processor <a href="https://en.wikipedia.org/wiki/Processor_register">registers</a> must be prefixed with the <code>%%</code> sequence in <code>extended</code> form and other symbols like immediates must start with the <code>$</code> symbol. The <code>OutputOperands</code> and <code>InputOperands</code> are comma-separated lists of <a href="https://en.wikipedia.org/wiki/C_%28programming_language%29">C</a> variables which may be provided with &quot;constraints&quot; and the <code>Clobbers</code> is a list of registers or other values which are modified by the assembler instructions from the <code>AssemblerTemplate</code> beyond those listed in the <code>OutputOperands</code>. Before we dive into the examples we have to know a little bit about <code>constraints</code>. A constraint is a string which specifies placement of an operand. For example the value of an operand may be written to a processor register or read from memory etc.</p>
<p>Consider the following simple example:</p>
<pre><code class="language-C">#include &lt;stdio.h&gt;

int main(void)
{
        unsigned long a = 5;
        unsigned long b = 10;
        unsigned long sum = 0;

        __asm__(&quot;addq %1,%2&quot; : &quot;=r&quot; (sum) : &quot;r&quot; (a), &quot;0&quot; (b));
        printf(&quot;a + b = %lu\n&quot;, sum);
        return 0;
}
</code></pre>
<p>Let's compile and run it to be sure that it works as expected:</p>
<pre><code>$ gcc test.c -o test
./test
a + b = 15
</code></pre>
<p>Ok, great. It works. Now let's look at this example in detail. Here we see a simple <code>C</code> program which calculates the sum of two variables placing the result into the <code>sum</code> variable and in the end we print the result. This example consists of three parts. The first is the assembly statement with the <a href="http://x86.renejeschke.de/html/file_module_x86_id_5.html">add</a> instruction. It adds the value of the source operand together with the value of the destination operand and stores the result in the destination operand. In our case:</p>
<pre><code class="language-assembly">addq %1, %2
</code></pre>
<p>will be expanded to the:</p>
<pre><code class="language-assembly">addq a, b
</code></pre>
<p>Variables and expressions which are listed in the <code>OutputOperands</code> and <code>InputOperands</code> may be matched in the <code>AssemblerTemplate</code>. An input/output operand is designated as <code>%N</code> where the <code>N</code> is the number of operand from left to right beginning from <code>zero</code>. The second part of the our assembly statement is located after the first <code>:</code> symbol and contains the definition of the output value:</p>
<pre><code class="language-assembly">&quot;=r&quot; (sum)
</code></pre>
<p>Notice that the <code>sum</code> is marked with two special symbols: <code>=r</code>. This is the first constraint that we have encountered. The actual constraint here is only <code>r</code> itself. The <code>=</code> symbol is <code>modifier</code> which denotes output value. This tells to compiler that the previous value will be discarded and replaced by the new data. Besides the <code>=</code> modifier, <code>GCC</code> provides support for following three modifiers:</p>
<ul>
<li><code>+</code> - an operand is read and written by an instruction;</li>
<li><code>&amp;</code> - output register shouldn't overlap an input register and should be used only for output;</li>
<li><code>%</code> - tells the compiler that operands may be <a href="https://en.wikipedia.org/wiki/Commutative_property">commutative</a>.</li>
</ul>
<p>Now let's go back to the <code>r</code> qualifier. As I mentioned above, a qualifier denotes the placement of an operand. The <code>r</code> symbol means a value will be stored in one of the <a href="https://en.wikipedia.org/wiki/Processor_register">general purpose register</a>. The last part of our assembly statement:</p>
<pre><code class="language-assembly">&quot;r&quot; (a), &quot;0&quot; (b)
</code></pre>
<p>These are input operands - variables <code>a</code> and <code>b</code>. We already know what the <code>r</code> qualifier does. Now we can have a look at the constraint for the variable <code>b</code>. The <code>0</code> or any other digit from <code>1</code> to <code>9</code> is called &quot;matching constraint&quot;. With this a single operand can be used for multiple roles. The value of the constraint is the source operand index. In our case <code>0</code> will match <code>sum</code>. If we look at assembly output of our program:</p>
<pre><code class="language-C">0000000000400400 &lt;main&gt;:
  ...
  ...
  ...
  4004fe:       48 c7 45 f8 05 00 00    movq   $0x5,-0x8(%rbp)
  400506:       48 c7 45 f0 0a 00 00    movq   $0xa,-0x10(%rbp)

  400516:       48 8b 55 f8             mov    -0x8(%rbp),%rdx
  40051a:       48 8b 45 f0             mov    -0x10(%rbp),%rax
  40051e:       48 01 d0                add    %rdx,%rax
</code></pre>
<p>First of all our values <code>5</code> and <code>10</code> will be put at the stack and then these values will be moved to the two general purpose registers: <code>%rdx</code> and <code>%rax</code>.</p>
<p>This way the <code>%rax</code> register is used for storing the value of the <code>b</code> as well as storing the result of the calculation. <strong>NOTE</strong> that I've used <code>gcc 6.3.1</code> version, so the resulted code of your compiler may differ.</p>
<p>We have looked at input and output parameters of an inline assembly statement. Before we move on to other constraints supported by <code>gcc</code>, there is one remaining part of the inline assembly statement we have not discussed yet - <code>clobbers</code>.</p>
<h2 id="clobbers"><a class="header" href="#clobbers">Clobbers</a></h2>
<p>As mentioned above, the &quot;clobbered&quot; part should contain a comma-separated list of registers whose content will be modified by the assembler code. This is useful if our assembly expression needs additional registers for calculation. If we add clobbered registers to the inline assembly statement, the compiler take this into account and the register in question will not simultaneously be used by the compiler.</p>
<p>Consider the example from before, but we will add an additional, simple assembler instruction:</p>
<pre><code class="language-C">__asm__(&quot;movq $100, %%rdx\t\n&quot;
        &quot;addq %1,%2&quot; : &quot;=r&quot; (sum) : &quot;r&quot; (a), &quot;0&quot; (b));
</code></pre>
<p>If we look at the assembly output:</p>
<pre><code class="language-C">0000000000400400 &lt;main&gt;:
  ...
  ...
  ...
  4004fe:       48 c7 45 f8 05 00 00    movq   $0x5,-0x8(%rbp)
  400506:       48 c7 45 f0 0a 00 00    movq   $0xa,-0x10(%rbp)

  400516:       48 8b 55 f8             mov    -0x8(%rbp),%rdx
  40051a:       48 8b 45 f0             mov    -0x10(%rbp),%rax

  40051e:       48 c7 c2 64 00 00 00    mov    $0x64,%rdx
  400525:       48 01 d0                add    %rdx,%rax
</code></pre>
<p>we will see that the <code>%rdx</code> register is overwritten with <code>0x64</code> or <code>100</code> and the result will be <code>110</code> instead of <code>10</code>. Now if we add the <code>%rdx</code> register to the list of <code>clobbered</code> registers:</p>
<pre><code class="language-C">__asm__(&quot;movq $100, %%rdx\t\n&quot;
        &quot;addq %1,%2&quot; : &quot;=r&quot; (sum) : &quot;r&quot; (a), &quot;0&quot; (b) : &quot;%rdx&quot;);
</code></pre>
<p>and look at the assembler output again:</p>
<pre><code class="language-C">0000000000400400 &lt;main&gt;:
  4004fe:       48 c7 45 f8 05 00 00    movq   $0x5,-0x8(%rbp)
  400506:       48 c7 45 f0 0a 00 00    movq   $0xa,-0x10(%rbp)

  400516:       48 8b 4d f8             mov    -0x8(%rbp),%rcx
  40051a:       48 8b 45 f0             mov    -0x10(%rbp),%rax

  40051e:       48 c7 c2 64 00 00 00    mov    $0x64,%rdx
  400525:       48 01 c8                add    %rcx,%rax
</code></pre>
<p>the <code>%rcx</code> register will be used for <code>sum</code> calculation, preserving the intended semantics of the program. Besides general purpose registers, we may pass two special specifiers. They are:</p>
<ul>
<li><code>cc</code>;</li>
<li><code>memory</code>.</li>
</ul>
<p>The first - <code>cc</code> indicates that an assembler code modifies <a href="https://en.wikipedia.org/wiki/FLAGS_register">flags</a> register. This is typically used if the assembly within contains arithmetic or logic instructions:</p>
<pre><code class="language-C">__asm__(&quot;incq %0&quot; ::&quot;&quot;(variable): &quot;cc&quot;);
</code></pre>
<p>The second <code>memory</code> specifier tells the compiler that the given inline assembly statement executes read/write operations on memory not specified by operands in the output list. This prevents the compiler from keeping memory values loaded and cached in registers. Let's take a look at the following example:</p>
<pre><code class="language-C">#include &lt;stdio.h&gt;

int main(void)
{
        unsigned long a[3] = {10000000000, 0, 1};
        unsigned long b = 5;

        __asm__ volatile(&quot;incq %0&quot; :: &quot;m&quot; (a[0]));

        printf(&quot;a[0] - b = %lu\n&quot;, a[0] - b);
        return 0;
}
</code></pre>
<p>This example may be artificial, but it illustrates the main idea. Here we have an array of integers and one integer variable. The example is pretty simple, we take the first element of <code>a</code> and increment its value. After this we subtract the value of <code>b</code> from the  first element of <code>a</code>. In the end we print the result. If we compile and run this simple example the result may surprise you:</p>
<pre><code>~$ gcc -O3  test.c -o test
~$ ./test
a[0] - b = 9999999995
</code></pre>
<p>The result is <code>a[0] - b = 9999999995</code> here, but why? We incremented <code>a[0]</code> and subtracted <code>b</code>, so the result should be <code>a[0] - b = 9999999996</code> here.</p>
<p>If we have a look at the assembler output for this example:</p>
<pre><code class="language-assembly">00000000004004f6 &lt;main&gt;:
  4004b4:       48 b8 00 e4 0b 54 02    movabs $0x2540be400,%rax
  4004be:       48 89 04 24             mov    %rax,(%rsp)
  ...
  ...
  ...
  40050e:       ff 44 24 f0             incq   (%rsp)

  4004d8:       48 be fb e3 0b 54 02    movabs $0x2540be3fb,%rsi
</code></pre>
<p>we will see that the first element of the <code>a</code> contains the value <code>0x2540be400</code> (<code>10000000000</code>). The last two lines of code are the actual calculations.</p>
<p>We see our increment instruction with <code>incq</code> but then just a move of <code>0x2540be3fb</code> (<code>9999999995</code>) to the <code>%rsi</code> register. This looks strange.</p>
<p>The problem is we have passed the <code>-O3</code> flag to <code>gcc</code>, so the compiler did some constant folding and propagation to determine the result of <code>a[0] - 5</code> at compile time and reduced it to a <code>movabs</code> with a constant <code>0x2540be3fb</code> or <code>9999999995</code> in runtime.</p>
<p>Let's now add <code>memory</code> to the clobbers list:</p>
<pre><code class="language-C">__asm__ volatile(&quot;incq %0&quot; :: &quot;m&quot; (a[0]) : &quot;memory&quot;);
</code></pre>
<p>and the new result of running this is:</p>
<pre><code>~$ gcc -O3  test.c -o test
~$ ./test
a[0] - b = 9999999996
</code></pre>
<p>Now the result is correct. If we look at the assembly output again:</p>
<pre><code class="language-assembly">00000000004004f6 &lt;main&gt;:
  400404:       48 b8 00 e4 0b 54 02    movabs $0x2540be400,%rax
  40040b:       00 00 00
  40040e:       48 89 04 24             mov    %rax,(%rsp)
  400412:       48 c7 44 24 08 00 00    movq   $0x0,0x8(%rsp)
  400419:       00 00
  40041b:       48 c7 44 24 10 01 00    movq   $0x1,0x10(%rsp)
  400422:       00 00
  400424:       48 ff 04 24             incq   (%rsp)
  400428:       48 8b 04 24             mov    (%rsp),%rax
  400431:       48 8d 70 fb             lea    -0x5(%rax),%rsi
</code></pre>
<p>we will see one difference here which is in the last two lines:</p>
<pre><code class="language-assembly">  400428:       48 8b 04 24             mov    (%rsp),%rax
  400431:       48 8d 70 fb             lea    -0x5(%rax),%rsi
</code></pre>
<p>Instead of constant folding, <code>GCC</code> now preserves calculations in the assembly and places the value of <code>a[0]</code> in the <code>%rax</code> register afterwards. In the end it just subtracts the constant value of <code>b</code> from the <code>%rax</code> register and puts the result to the <code>%rsi</code>.</p>
<p>Besides the <code>memory</code> specifier, we also see a new constraint here - <code>m</code>. This constraint tells the compiler to use the address of <code>a[0]</code>, instead of its value. So, now we are finished with <code>clobbers</code> and we may continue by looking at other constraints supported by <code>GCC</code> besides <code>r</code> and <code>m</code> which we have already seen.</p>
<h2 id="constraints"><a class="header" href="#constraints">Constraints</a></h2>
<p>Now that we are finished with all three parts of an inline assembly statement, let's return to constraints. We already saw some constraints in the previous parts, like <code>r</code> which represents a <code>register</code> operand, <code>m</code> which represents a memory operand and <code>0-9</code> which represent a reused, indexed operand. Besides these <code>GCC</code> provides support for other constraints. For example the <code>i</code> constraint represents an <code>immediate</code> integer operand with known value:</p>
<pre><code class="language-C">#include &lt;stdio.h&gt;

int main(void)
{
        int a = 0;

        __asm__(&quot;movl %1, %0&quot; : &quot;=r&quot;(a) : &quot;i&quot;(100));
        printf(&quot;a = %d\n&quot;, a);
        return 0;
}
</code></pre>
<p>The result is:</p>
<pre><code>~$ gcc test.c -o test
~$ ./test
a = 100
</code></pre>
<p>Or for example <code>I</code> which represents an immediate 32-bit integer. The difference between <code>i</code> and <code>I</code> is that <code>i</code> is general, whereas <code>I</code> is strictly specified to 32-bit integer data. For example if you try to compile the following code:</p>
<pre><code class="language-C">unsigned long test_asm(int nr)
{
        unsigned long a = 0;

        __asm__(&quot;movq %1, %0&quot; : &quot;=r&quot;(a) : &quot;I&quot;(0xffffffffffff));
        return a;
}
</code></pre>
<p>you will get an error:</p>
<pre><code>$ gcc -O3 test.c -o test
test.c: In function ‘test_asm’:
test.c:7:9: warning: asm operand 1 probably doesn’t match constraints
         __asm__(&quot;movq %1, %0&quot; : &quot;=r&quot;(a) : &quot;I&quot;(0xffffffffffff));
         ^
test.c:7:9: error: impossible constraint in ‘asm’
</code></pre>
<p>when at the same time:</p>
<pre><code class="language-C">unsigned long test_asm(int nr)
{
        unsigned long a = 0;

        __asm__(&quot;movq %1, %0&quot; : &quot;=r&quot;(a) : &quot;i&quot;(0xffffffffffff));
        return a;
}
</code></pre>
<p>works perfectly:</p>
<pre><code>~$ gcc -O3 test.c -o test
~$ echo $?
0
</code></pre>
<p><code>GCC</code> also supports <code>J</code>, <code>K</code>, <code>N</code> constraints for integer constants in the range of 0-63 bits, signed 8-bit integer constants and unsigned 8-bit integer constants respectively. The <code>o</code> constraint represents a memory operand with an <code>offsetable</code> memory address. For example:</p>
<pre><code class="language-C">#include &lt;stdio.h&gt;

int main(void)
{
        static unsigned long arr[3] = {0, 1, 2};
        static unsigned long element;

        __asm__ volatile(&quot;movq 16+%1, %0&quot; : &quot;=r&quot;(element) : &quot;o&quot;(arr));
        printf(&quot;%lu\n&quot;, element);
        return 0;
}
</code></pre>
<p>The result, as expected:</p>
<pre><code>~$ gcc -O3 test.c -o test
~$ ./test
2
</code></pre>
<p>All of these constraints may be combined (so long as they do not conflict). In this case the compiler will choose the best one for a certain situation. For example:</p>
<pre><code class="language-C">unsigned long a = 10;
unsigned long b = 20;

void main(void)
{
    __asm__ (&quot;movq %1,%0&quot; : &quot;=mr&quot;(b) : &quot;rm&quot;(a));
}
</code></pre>
<p>will use a memory operand:</p>
<pre><code class="language-assembly">main:
        movq a(%rip),b(%rip)
        ret
b:
        .quad   20
a:
        .quad   10
</code></pre>
<p>instead of direct usage of general purpose registers.</p>
<p>That's about all of the commonly used constraints in inline assembly statements. You can find more in the official <a href="https://gcc.gnu.org/onlinedocs/gcc/Simple-Constraints.html#Simple-Constraints">documentation</a>.</p>
<h2 id="architecture-specific-constraints"><a class="header" href="#architecture-specific-constraints">Architecture specific constraints</a></h2>
<p>Before we finish, let's look at the set of special constraints. These constrains are architecture specific and as this book is specific to the <a href="https://en.wikipedia.org/wiki/X86-64">x86_64</a> architecture, we will look at constraints related to it. First of all the set of <code>a</code> ... <code>d</code> and also <code>S</code> and <code>D</code> constraints represent <a href="https://en.wikipedia.org/wiki/Processor_register">generic purpose</a> registers. In this case the <code>a</code> constraint corresponds to <code>%al</code>, <code>%ax</code>, <code>%eax</code> or <code>%rax</code> register depending on instruction size. The <code>S</code> and <code>D</code> constraints are <code>%si</code> and <code>%di</code> registers respectively. For example let's take our previous example. We can see in its assembly output that value of the <code>a</code> variable is stored in the <code>%eax</code> register. Now let's look at the assembly output of the same assembly, but with other constraint:</p>
<pre><code class="language-C">#include &lt;stdio.h&gt;

int a = 1;

int main(void)
{
        int b;
        __asm__ (&quot;movq %1,%0&quot; : &quot;=r&quot;(b) : &quot;d&quot;(a));
        return b;
}
</code></pre>
<p>Now we see that value of the <code>a</code> variable will be stored in the <code>%rax</code> register:</p>
<pre><code class="language-assembly">0000000000400400 &lt;main&gt;:
  4004aa:       48 8b 05 6f 0b 20 00    mov    0x200b6f(%rip),%rax        # 601020 &lt;a&gt;
</code></pre>
<p>The <code>f</code> and <code>t</code> constraints represent any floating point stack register - <code>%st</code> and the top of the floating point stack respectively. The <code>u</code> constraint represents the second value from the top of the floating point stack.</p>
<p>That's all. You may find more details about <a href="https://en.wikipedia.org/wiki/X86-64">x86_64</a> and general constraints in the official <a href="https://gcc.gnu.org/onlinedocs/gcc/Machine-Constraints.html#Machine-Constraints">documentation</a>.</p>
<h2 id="links"><a class="header" href="#links">Links</a></h2>
<ul>
<li><a href="https://github.com/torvalds/linux">Linux kernel source code</a></li>
<li><a href="https://en.wikipedia.org/wiki/Assembly_language">assembly programming language</a></li>
<li><a href="https://en.wikipedia.org/wiki/GNU_Compiler_Collection">GCC</a></li>
<li><a href="https://gcc.gnu.org/onlinedocs/gcc/C-Extensions.html">GNU extension</a></li>
<li><a href="https://en.wikipedia.org/wiki/Global_Descriptor_Table">Global Descriptor Table</a></li>
<li><a href="https://en.wikipedia.org/wiki/Processor_register">Processor registers</a></li>
<li><a href="http://x86.renejeschke.de/html/file_module_x86_id_5.html">add instruction</a></li>
<li><a href="https://en.wikipedia.org/wiki/FLAGS_register">flags register</a></li>
<li><a href="https://en.wikipedia.org/wiki/X86-64">x86_64</a></li>
<li><a href="https://gcc.gnu.org/onlinedocs/gcc/Machine-Constraints.html#Machine-Constraints">constraints</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../Theory/linux-theory-2.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../Misc/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../Theory/linux-theory-2.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../Misc/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
