<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Introduction to Control Groups - Linux Insides</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../Booting/index.html">Booting</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Booting/linux-bootstrap-1.html">From bootloader to kernel</a></li><li class="chapter-item expanded "><a href="../Booting/linux-bootstrap-2.html">First steps in the kernel setup code</a></li><li class="chapter-item expanded "><a href="../Booting/linux-bootstrap-3.html">Video mode initialization and transition to protected mode</a></li><li class="chapter-item expanded "><a href="../Booting/linux-bootstrap-4.html">Transition to 64-bit mode</a></li><li class="chapter-item expanded "><a href="../Booting/linux-bootstrap-5.html">Kernel decompression</a></li><li class="chapter-item expanded "><a href="../Booting/linux-bootstrap-6.html">Kernel load address randomization</a></li></ol></li><li class="chapter-item expanded "><a href="../Initialization/index.html">Initialization</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Initialization/linux-initialization-1.html">First steps in the kernel</a></li><li class="chapter-item expanded "><a href="../Initialization/linux-initialization-2.html">Early interrupts handler</a></li><li class="chapter-item expanded "><a href="../Initialization/linux-initialization-3.html">Last preparations before the kernel entry point</a></li><li class="chapter-item expanded "><a href="../Initialization/linux-initialization-4.html">Kernel entry point</a></li><li class="chapter-item expanded "><a href="../Initialization/linux-initialization-5.html">Continue architecture-specific boot-time initializations</a></li><li class="chapter-item expanded "><a href="../Initialization/linux-initialization-6.html">Architecture-specific initializations, again...</a></li><li class="chapter-item expanded "><a href="../Initialization/linux-initialization-7.html">End of the architecture-specific initializations, almost...</a></li><li class="chapter-item expanded "><a href="../Initialization/linux-initialization-8.html">Scheduler initialization</a></li><li class="chapter-item expanded "><a href="../Initialization/linux-initialization-9.html">RCU initialization</a></li><li class="chapter-item expanded "><a href="../Initialization/linux-initialization-10.html">End of initialization</a></li></ol></li><li class="chapter-item expanded "><a href="../Interrupts/index.html">Interrupts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Interrupts/linux-interrupts-1.html">Introduction</a></li><li class="chapter-item expanded "><a href="../Interrupts/linux-interrupts-2.html">Start to dive into interrupts</a></li><li class="chapter-item expanded "><a href="../Interrupts/linux-interrupts-3.html">Interrupt handlers</a></li><li class="chapter-item expanded "><a href="../Interrupts/linux-interrupts-4.html">Initialization of non-early interrupt gates</a></li><li class="chapter-item expanded "><a href="../Interrupts/linux-interrupts-5.html">Implementation of some exception handlers</a></li><li class="chapter-item expanded "><a href="../Interrupts/linux-interrupts-6.html">Handling Non-Maskable interrupts</a></li><li class="chapter-item expanded "><a href="../Interrupts/linux-interrupts-7.html">Dive into external hardware interrupts</a></li><li class="chapter-item expanded "><a href="../Interrupts/linux-interrupts-8.html">Initialization of external hardware interrupts structures</a></li><li class="chapter-item expanded "><a href="../Interrupts/linux-interrupts-9.html">Softirq, Tasklets and Workqueues</a></li><li class="chapter-item expanded "><a href="../Interrupts/linux-interrupts-10.html">Last part</a></li></ol></li><li class="chapter-item expanded "><a href="../SysCall/index.html">System calls</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../SysCall/linux-syscall-1.html">Introduction to system calls</a></li><li class="chapter-item expanded "><a href="../SysCall/linux-syscall-2.html">How the Linux kernel handles a system call</a></li><li class="chapter-item expanded "><a href="../SysCall/linux-syscall-3.html">vsyscall and vDSO</a></li><li class="chapter-item expanded "><a href="../SysCall/linux-syscall-4.html">How the Linux kernel runs a program</a></li><li class="chapter-item expanded "><a href="../SysCall/linux-syscall-5.html">Implementation of the open system call</a></li><li class="chapter-item expanded "><a href="../SysCall/linux-syscall-6.html">Limits on resources in Linux</a></li></ol></li><li class="chapter-item expanded "><a href="../Timers/index.html">Timers and time management</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Timers/linux-timers-1.html">Introduction</a></li><li class="chapter-item expanded "><a href="../Timers/linux-timers-2.html">Clocksource framework</a></li><li class="chapter-item expanded "><a href="../Timers/linux-timers-3.html">The tick broadcast framework and dyntick</a></li><li class="chapter-item expanded "><a href="../Timers/linux-timers-4.html">Introduction to timers</a></li><li class="chapter-item expanded "><a href="../Timers/linux-timers-5.html">Clockevents framework</a></li><li class="chapter-item expanded "><a href="../Timers/linux-timers-6.html">x86 related clock sources</a></li><li class="chapter-item expanded "><a href="../Timers/linux-timers-7.html">Time related system calls</a></li></ol></li><li class="chapter-item expanded "><a href="../SyncPrim/index.html">Synchronization primitives</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../SyncPrim/linux-sync-1.html">Introduction to spinlocks</a></li><li class="chapter-item expanded "><a href="../SyncPrim/linux-sync-2.html">Queued spinlocks</a></li><li class="chapter-item expanded "><a href="../SyncPrim/linux-sync-3.html">Semaphores</a></li><li class="chapter-item expanded "><a href="../SyncPrim/linux-sync-4.html">Mutex</a></li><li class="chapter-item expanded "><a href="../SyncPrim/linux-sync-5.html">Reader/Writer semaphores</a></li><li class="chapter-item expanded "><a href="../SyncPrim/linux-sync-6.html">SeqLock</a></li><li class="chapter-item expanded "><div>RCU</div></li><li class="chapter-item expanded "><div>Lockdep</div></li></ol></li><li class="chapter-item expanded "><a href="../MM/index.html">Memory management</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../MM/linux-mm-1.html">Memblock</a></li><li class="chapter-item expanded "><a href="../MM/linux-mm-2.html">Fixmaps and ioremap</a></li><li class="chapter-item expanded "><a href="../MM/linux-mm-3.html">kmemcheck</a></li></ol></li><li class="chapter-item expanded "><a href="../Cgroups/index.html">Cgroups</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Cgroups/linux-cgroups-1.html" class="active">Introduction to Control Groups</a></li></ol></li><li class="chapter-item expanded "><div>SMP</div></li><li class="chapter-item expanded "><a href="../Concepts/index.html">Concepts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Concepts/linux-cpu-1.html">Per-CPU variables</a></li><li class="chapter-item expanded "><a href="../Concepts/linux-cpu-2.html">Cpumasks</a></li><li class="chapter-item expanded "><a href="../Concepts/linux-cpu-3.html">The initcall mechanism</a></li><li class="chapter-item expanded "><a href="../Concepts/linux-cpu-4.html">Notification Chains</a></li></ol></li><li class="chapter-item expanded "><a href="../DataStructures/index.html">Data Structures in the Linux Kernel</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../DataStructures/linux-datastructures-1.html">Doubly linked list</a></li><li class="chapter-item expanded "><a href="../DataStructures/linux-datastructures-2.html">Radix tree</a></li><li class="chapter-item expanded "><a href="../DataStructures/linux-datastructures-3.html">Bit arrays</a></li></ol></li><li class="chapter-item expanded "><a href="../Theory/index.html">Theory</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Theory/linux-theory-1.html">Paging</a></li><li class="chapter-item expanded "><a href="../Theory/linux-theory-2.html">Elf64</a></li><li class="chapter-item expanded "><a href="../Theory/linux-theory-3.html">Inline assembly</a></li><li class="chapter-item expanded "><div>CPUID</div></li><li class="chapter-item expanded "><div>MSR</div></li></ol></li><li class="chapter-item expanded "><div>Initial ram disk</div></li><li><ol class="section"><li class="chapter-item expanded "><div>initrd</div></li></ol></li><li class="chapter-item expanded "><a href="../Misc/index.html">Misc</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Misc/linux-misc-1.html">Linux kernel development</a></li><li class="chapter-item expanded "><a href="../Misc/linux-misc-2.html">How the kernel is compiled</a></li><li class="chapter-item expanded "><a href="../Misc/linux-misc-3.html">Linkers</a></li><li class="chapter-item expanded "><a href="../Misc/linux-misc-4.html">Program startup process in userspace</a></li><li class="chapter-item expanded "><div>Write and Submit your first Linux kernel Patch</div></li><li class="chapter-item expanded "><div>Data types in the kernel</div></li></ol></li><li class="chapter-item expanded "><a href="../KernelStructures/index.html">KernelStructures</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../KernelStructures/linux-kernelstructure-1.html">IDT</a></li></ol></li><li class="chapter-item expanded "><a href="../LINKS.html">Useful links</a></li><li class="chapter-item expanded "><a href="../contributors.html">Contributors</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Linux Insides</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/0xAX/linux-insides/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="control-groups"><a class="header" href="#control-groups">Control Groups</a></h1>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p>This is the first part of the new chapter of the <a href="https://github.com/0xAX/linux-insides/blob/master/SUMMARY.md">linux insides</a> book and as you may guess by part's name - this part will cover <a href="https://en.wikipedia.org/wiki/Cgroups">control groups</a> or <code>cgroups</code> mechanism in the Linux kernel.</p>
<p><code>Cgroups</code> are special mechanism provided by the Linux kernel which allows us to allocate kind of <code>resources</code> like processor time, number of processes per group, amount of memory per control group or combination of such resources for a process or set of processes. <code>Cgroups</code> are organized hierarchically and here this mechanism is similar to usual processes as they are hierarchical too and child <code>cgroups</code> inherit set of certain parameters from their parents. But actually they are not the same. The main difference between <code>cgroups</code> and normal processes is that many different hierarchies of control groups may exist simultaneously in one time while normal process tree is always single. This was not a casual step because each control group hierarchy is attached to set of control group <code>subsystems</code>.</p>
<p>One <code>control group subsystem</code> represents one kind of resources like a processor time or number of <a href="https://en.wikipedia.org/wiki/Process_identifier">pids</a> or in other words number of processes for a <code>control group</code>. Linux kernel provides support for following twelve <code>control group subsystems</code>:</p>
<ul>
<li><code>cpuset</code> - assigns individual processor(s) and memory nodes to task(s) in a group;</li>
<li><code>cpu</code> - uses the scheduler to provide cgroup tasks access to the processor resources;</li>
<li><code>cpuacct</code> - generates reports about processor usage by a group;</li>
<li><code>io</code> - sets limit to read/write from/to <a href="https://en.wikipedia.org/wiki/Device_file">block devices</a>;</li>
<li><code>memory</code> - sets limit on memory usage by a task(s) from a group;</li>
<li><code>devices</code> - allows access to devices by a task(s) from a group;</li>
<li><code>freezer</code> - allows to suspend/resume for a task(s) from a group;</li>
<li><code>net_cls</code> - allows to mark network packets from task(s) from a group;</li>
<li><code>net_prio</code> - provides a way to dynamically set the priority of network traffic per network interface for a group;</li>
<li><code>perf_event</code> - provides access to <a href="https://en.wikipedia.org/wiki/Perf_(Linux)">perf events</a> to a group;</li>
<li><code>hugetlb</code> - activates support for <a href="https://www.kernel.org/doc/Documentation/vm/hugetlbpage.txt">huge pages</a> for a group;</li>
<li><code>pid</code> - sets limit to number of processes in a group.</li>
</ul>
<p>Each of these control group subsystems depends on related configuration option. For example the <code>cpuset</code> subsystem should be enabled via <code>CONFIG_CPUSETS</code> kernel configuration option, the <code>io</code> subsystem via <code>CONFIG_BLK_CGROUP</code> kernel configuration option and etc. All of these kernel configuration options may be found in the <code>General setup → Control Group support</code> menu:</p>
<p><img src="images/menuconfig.png" alt="menuconfig" /></p>
<p>You may see enabled control groups on your computer via <a href="https://en.wikipedia.org/wiki/Procfs">proc</a> filesystem:</p>
<pre><code>$ cat /proc/cgroups
#subsys_name	hierarchy	num_cgroups	enabled
cpuset	8	1	1
cpu	7	66	1
cpuacct	7	66	1
blkio	11	66	1
memory	9	94	1
devices	6	66	1
freezer	2	1	1
net_cls	4	1	1
perf_event	3	1	1
net_prio	4	1	1
hugetlb	10	1	1
pids	5	69	1
</code></pre>
<p>or via <a href="https://en.wikipedia.org/wiki/Sysfs">sysfs</a>:</p>
<pre><code>$ ls -l /sys/fs/cgroup/
total 0
dr-xr-xr-x 5 root root  0 Dec  2 22:37 blkio
lrwxrwxrwx 1 root root 11 Dec  2 22:37 cpu -&gt; cpu,cpuacct
lrwxrwxrwx 1 root root 11 Dec  2 22:37 cpuacct -&gt; cpu,cpuacct
dr-xr-xr-x 5 root root  0 Dec  2 22:37 cpu,cpuacct
dr-xr-xr-x 2 root root  0 Dec  2 22:37 cpuset
dr-xr-xr-x 5 root root  0 Dec  2 22:37 devices
dr-xr-xr-x 2 root root  0 Dec  2 22:37 freezer
dr-xr-xr-x 2 root root  0 Dec  2 22:37 hugetlb
dr-xr-xr-x 5 root root  0 Dec  2 22:37 memory
lrwxrwxrwx 1 root root 16 Dec  2 22:37 net_cls -&gt; net_cls,net_prio
dr-xr-xr-x 2 root root  0 Dec  2 22:37 net_cls,net_prio
lrwxrwxrwx 1 root root 16 Dec  2 22:37 net_prio -&gt; net_cls,net_prio
dr-xr-xr-x 2 root root  0 Dec  2 22:37 perf_event
dr-xr-xr-x 5 root root  0 Dec  2 22:37 pids
dr-xr-xr-x 5 root root  0 Dec  2 22:37 systemd
</code></pre>
<p>As you already may guess that <code>control groups</code> mechanism is not such mechanism which was invented only directly to the needs of the Linux kernel, but mostly for userspace needs. To use a <code>control group</code>, we should create it at first. We may create a <code>cgroup</code> via two ways.</p>
<p>The first way is to create subdirectory in any subsystem from <code>/sys/fs/cgroup</code> and add a pid of a task to a <code>tasks</code> file which will be created automatically right after we will create the subdirectory.</p>
<p>The second way is to create/destroy/manage <code>cgroups</code> with utils from <code>libcgroup</code> library (<code>libcgroup-tools</code> in Fedora).</p>
<p>Let's consider a simple example. Following <a href="https://www.gnu.org/software/bash/">bash</a> script will print a line to <code>/dev/tty</code> device which represents control terminal for the current process:</p>
<pre><code class="language-shell">#!/bin/bash

while :
do
    echo &quot;print line&quot; &gt; /dev/tty
    sleep 5
done
</code></pre>
<p>So, if we will run this script we will see following result:</p>
<pre><code>$ sudo chmod +x cgroup_test_script.sh
~$ ./cgroup_test_script.sh
print line
print line
print line
...
...
...
</code></pre>
<p>Now let's go to the place where <code>cgroupfs</code> is mounted on our computer. As we just saw, this is <code>/sys/fs/cgroup</code> directory, but you may mount it everywhere you want.</p>
<pre><code>$ cd /sys/fs/cgroup
</code></pre>
<p>And now let's go to the <code>devices</code> subdirectory which represents kind of resources that allows or denies access to devices by tasks in a <code>cgroup</code>:</p>
<pre><code># cd devices
</code></pre>
<p>and create <code>cgroup_test_group</code> directory there:</p>
<pre><code># mkdir cgroup_test_group
</code></pre>
<p>After creation of the <code>cgroup_test_group</code> directory, following files will be generated there:</p>
<pre><code>/sys/fs/cgroup/devices/cgroup_test_group$ ls -l
total 0
-rw-r--r-- 1 root root 0 Dec  3 22:55 cgroup.clone_children
-rw-r--r-- 1 root root 0 Dec  3 22:55 cgroup.procs
--w------- 1 root root 0 Dec  3 22:55 devices.allow
--w------- 1 root root 0 Dec  3 22:55 devices.deny
-r--r--r-- 1 root root 0 Dec  3 22:55 devices.list
-rw-r--r-- 1 root root 0 Dec  3 22:55 notify_on_release
-rw-r--r-- 1 root root 0 Dec  3 22:55 tasks
</code></pre>
<p>For this moment we are interested in <code>tasks</code> and <code>devices.deny</code> files. The first <code>tasks</code> files should contain pid(s) of processes which will be attached to the <code>cgroup_test_group</code>. The second <code>devices.deny</code> file contain list of denied devices. By default a newly created group has no any limits for devices access. To forbid a device (in our case it is <code>/dev/tty</code>) we should write to the <code>devices.deny</code> following line:</p>
<pre><code># echo &quot;c 5:0 w&quot; &gt; devices.deny
</code></pre>
<p>Let's go step by step through this line. The first <code>c</code> letter represents type of a device. In our case the <code>/dev/tty</code> is <code>char device</code>. We can verify this from output of <code>ls</code> command:</p>
<pre><code>~$ ls -l /dev/tty
crw-rw-rw- 1 root tty 5, 0 Dec  3 22:48 /dev/tty
</code></pre>
<p>see the first <code>c</code> letter in a permissions list. The second part is <code>5:0</code> is major and minor numbers of the device. You can see these numbers in the output of <code>ls</code> too. And the last <code>w</code> letter forbids tasks to write to the specified device. So let's start the <code>cgroup_test_script.sh</code> script:</p>
<pre><code>~$ ./cgroup_test_script.sh
print line
print line
print line
...
...
</code></pre>
<p>and add pid of this process to the <code>devices/tasks</code> file of our group:</p>
<pre><code># echo $(pidof -x cgroup_test_script.sh) &gt; /sys/fs/cgroup/devices/cgroup_test_group/tasks
</code></pre>
<p>The result of this action will be as expected:</p>
<pre><code>~$ ./cgroup_test_script.sh
print line
print line
print line
print line
print line
print line
./cgroup_test_script.sh: line 5: /dev/tty: Operation not permitted
</code></pre>
<p>Similar situation will be when you will run you <a href="https://en.wikipedia.org/wiki/Docker_(software)">docker</a> containers for example:</p>
<pre><code>~$ docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES
fa2d2085cd1c        mariadb:10          &quot;docker-entrypoint...&quot;   12 days ago         Up 4 minutes        0.0.0.0:3306-&gt;3306/tcp   mysql-work

~$ cat /sys/fs/cgroup/devices/docker/fa2d2085cd1c8d797002c77387d2061f56fefb470892f140d0dc511bd4d9bb61/tasks | head -3
5501
5584
5585
...
...
...
</code></pre>
<p>So, during startup of a <code>docker</code> container, <code>docker</code> will create a <code>cgroup</code> for processes in this container:</p>
<pre><code>$ docker exec -it mysql-work /bin/bash
$ top
  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                                   1 mysql     20   0  963996 101268  15744 S   0.0  0.6   0:00.46 mysqld
   71 root      20   0   20248   3028   2732 S   0.0  0.0   0:00.01 bash
   77 root      20   0   21948   2424   2056 R   0.0  0.0   0:00.00 top
</code></pre>
<p>And we may see this <code>cgroup</code> on host machine:</p>
<pre><code class="language-C">$ systemd-cgls

Control group /:
-.slice
├─docker
│ └─fa2d2085cd1c8d797002c77387d2061f56fefb470892f140d0dc511bd4d9bb61
│   ├─5501 mysqld
│   └─6404 /bin/bash
</code></pre>
<p>Now we know a little about <code>control groups</code> mechanism, how to use it manually and what's the purpose of this mechanism. It's time to look inside of the Linux kernel source code and start to dive into implementation of this mechanism.</p>
<h2 id="early-initialization-of-control-groups"><a class="header" href="#early-initialization-of-control-groups">Early initialization of control groups</a></h2>
<p>Now after we just saw a little theory about <code>control groups</code> Linux kernel mechanism, we may start to dive into the source code of Linux kernel to get better acquainted with this mechanism. As always we will start from the initialization of <code>control groups</code>. Initialization of <code>cgroups</code> is divided into two parts in the Linux kernel: early and late. In this part we will consider only <code>early</code> part and <code>late</code> part will be considered in next parts.</p>
<p>Early initialization of <code>cgroups</code> starts from the call of the:</p>
<pre><code class="language-C">cgroup_init_early();
</code></pre>
<p>function in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/init/main.c">init/main.c</a> during early initialization of the Linux kernel. This function is defined in the <a href="https://github.com/torvalds/linux/blob/master/kernel/cgroup/cgroup.c">kernel/cgroup/cgroup.c</a> source code file and starts from the definition of two following local variables:</p>
<pre><code class="language-C">int __init cgroup_init_early(void)
{
	static struct cgroup_sb_opts __initdata opts;
	struct cgroup_subsys *ss;
    ...
    ...
    ...
}
</code></pre>
<p>The <code>cgroup_sb_opts</code> structure defined in the same source code file and looks:</p>
<pre><code class="language-C">struct cgroup_sb_opts {
	u16 subsys_mask;
	unsigned int flags;
	char *release_agent;
	bool cpuset_clone_children;
	char *name;
	bool none;
};
</code></pre>
<p>which represents mount options of <code>cgroupfs</code>. For example we may create named cgroup hierarchy (with name <code>my_cgrp</code>) with the <code>name=</code> option and without any subsystems:</p>
<pre><code>$ mount -t cgroup -oname=my_cgrp,none /mnt/cgroups
</code></pre>
<p>The second variable - <code>ss</code> has type - <code>cgroup_subsys</code> structure which is defined in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/include/linux/cgroup-defs.h">include/linux/cgroup-defs.h</a> header file and as you may guess from the name of the type, it represents a <code>cgroup</code> subsystem. This structure contains various fields and callback functions like:</p>
<pre><code class="language-C">struct cgroup_subsys {
    int (*css_online)(struct cgroup_subsys_state *css);
    void (*css_offline)(struct cgroup_subsys_state *css);
    ...
    ...
    ...
    bool early_init:1;
    int id;
    const char *name;
    struct cgroup_root *root;
    ...
    ...
    ...
}
</code></pre>
<p>Where for example <code>css_online</code> and <code>css_offline</code> callbacks are called after a cgroup successfully will complete all allocations and a cgroup will be before releasing respectively. The <code>early_init</code> flags marks subsystems which may/should be initialized early. The <code>id</code> and <code>name</code> fields represents unique identifier in the array of registered subsystems for a cgroup and <code>name</code> of a subsystem respectively. The last - <code>root</code> fields represents pointer to the root of of a cgroup hierarchy.</p>
<p>Of course the <code>cgroup_subsys</code> structure is bigger and has other fields, but it is enough for now. Now as we got to know important structures related to <code>cgroups</code> mechanism, let's return to the <code>cgroup_init_early</code> function. Main purpose of this function is to do early initialization of some subsystems. As you already may guess, these <code>early</code> subsystems should have <code>cgroup_subsys-&gt;early_init = 1</code>. Let's look what subsystems may be initialized early.</p>
<p>After the definition of the two local variables we may see following lines of code:</p>
<pre><code class="language-C">init_cgroup_root(&amp;cgrp_dfl_root, &amp;opts);
cgrp_dfl_root.cgrp.self.flags |= CSS_NO_REF;
</code></pre>
<p>Here we may see call of the <code>init_cgroup_root</code> function which will execute initialization of the default unified hierarchy and after this we set <code>CSS_NO_REF</code> flag in state of this default <code>cgroup</code> to disable reference counting for this css. The <code>cgrp_dfl_root</code> is defined in the same source code file:</p>
<pre><code class="language-C">struct cgroup_root cgrp_dfl_root;
</code></pre>
<p>Its <code>cgrp</code> field represented by the <code>cgroup</code> structure which represents a <code>cgroup</code> as you already may guess and defined in the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/include/linux/cgroup-defs.h">include/linux/cgroup-defs.h</a> header file. We already know that a process is represented by the <code>task_struct</code> in the Linux kernel. The <code>task_struct</code> does not contain direct link to a <code>cgroup</code> where this task is attached. But it may be reached via <code>css_set</code> field of the <code>task_struct</code>. This <code>css_set</code> structure holds pointer to the array of subsystem states:</p>
<pre><code class="language-C">struct css_set {
    ...
    ...
    ....
    struct cgroup_subsys_state *subsys[CGROUP_SUBSYS_COUNT];
    ...
    ...
    ...
}
</code></pre>
<p>And via the <code>cgroup_subsys_state</code>, a process may get a <code>cgroup</code> that this process is attached to:</p>
<pre><code class="language-C">struct cgroup_subsys_state {
    ...
    ...
    ...
    struct cgroup *cgroup;
    ...
    ...
    ...
}
</code></pre>
<p>So, the overall picture of <code>cgroups</code> related data structure is following:</p>
<pre><code>+-------------+         +---------------------+    +-------------&gt;+---------------------+          +----------------+
| task_struct |         |       css_set       |    |              | cgroup_subsys_state |          |     cgroup     |
+-------------+         |                     |    |              +---------------------+          +----------------+
|             |         |                     |    |              |                     |          |     flags      |
|             |         |                     |    |              +---------------------+          |  cgroup.procs  |
|             |         |                     |    |              |        cgroup       |---------&gt;|       id       |
|             |         |                     |    |              +---------------------+          |      ....      |
|-------------+         |---------------------+----+                                               +----------------+
|   cgroups   | ------&gt; | cgroup_subsys_state | array of cgroup_subsys_state
|-------------+         +---------------------+------------------&gt;+---------------------+          +----------------+
|             |         |                     |                   | cgroup_subsys_state |          |      cgroup    |
+-------------+         +---------------------+                   +---------------------+          +----------------+
                                                                  |                     |          |      flags     |
                                                                  +---------------------+          |   cgroup.procs |
                                                                  |        cgroup       |---------&gt;|        id      |
                                                                  +---------------------+          |       ....     |
                                                                  |    cgroup_subsys    |          +----------------+
                                                                  +---------------------+
                                                                             |
                                                                             |
                                                                             ↓
                                                                  +---------------------+
                                                                  |    cgroup_subsys    |
                                                                  +---------------------+
                                                                  |         id          |
                                                                  |        name         |
                                                                  |      css_online     |
                                                                  |      css_ofline     |
                                                                  |        attach       |
                                                                  |         ....        |
                                                                  +---------------------+
</code></pre>
<p>So, the <code>init_cgroup_root</code> fills the <code>cgrp_dfl_root</code> with the default values. The next thing is assigning initial <code>css_set</code> to the <code>init_task</code> which represents first process in the system:</p>
<pre><code class="language-C">RCU_INIT_POINTER(init_task.cgroups, &amp;init_css_set);
</code></pre>
<p>And the last big thing in the <code>cgroup_init_early</code> function is initialization of <code>early cgroups</code>. Here we go over all registered subsystems and assign unique identity number, name of a subsystem and call the <code>cgroup_init_subsys</code> function for subsystems which are marked as early:</p>
<pre><code class="language-C">for_each_subsys(ss, i) {
		ss-&gt;id = i;
		ss-&gt;name = cgroup_subsys_name[i];

        if (ss-&gt;early_init)
			cgroup_init_subsys(ss, true);
}
</code></pre>
<p>The <code>for_each_subsys</code> here is a macro which is defined in the <a href="https://github.com/torvalds/linux/blob/master/kernel/cgroup/cgroup.c">kernel/cgroup/cgroup.c</a> source code file and just expands to the <code>for</code> loop over <code>cgroup_subsys</code> array. Definition of this array may be found in the same source code file and it looks in a little unusual way:</p>
<pre><code class="language-C">#define SUBSYS(_x) [_x ## _cgrp_id] = &amp;_x ## _cgrp_subsys,
    static struct cgroup_subsys *cgroup_subsys[] = {
        #include &lt;linux/cgroup_subsys.h&gt;
};
#undef SUBSYS
</code></pre>
<p>It is defined as <code>SUBSYS</code> macro which takes one argument (name of a subsystem) and defines <code>cgroup_subsys</code> array of cgroup subsystems. Additionally we may see that the array is initialized with content of the <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/include/linux/cgroup_subsys.h">linux/cgroup_subsys.h</a> header file. If we will look inside of this header file we will see again set of the <code>SUBSYS</code> macros with the given subsystems names:</p>
<pre><code class="language-C">#if IS_ENABLED(CONFIG_CPUSETS)
SUBSYS(cpuset)
#endif

#if IS_ENABLED(CONFIG_CGROUP_SCHED)
SUBSYS(cpu)
#endif
...
...
...
</code></pre>
<p>This works because of <code>#undef</code> statement after first definition of the <code>SUBSYS</code> macro. Look at the <code>&amp;_x ## _cgrp_subsys</code> expression. The <code>##</code> operator concatenates right and left expression in a <code>C</code> macro. So as we passed <code>cpuset</code>, <code>cpu</code> and etc., to the <code>SUBSYS</code> macro, somewhere <code>cpuset_cgrp_subsys</code>, <code>cpu_cgrp_subsys</code> should be defined. And that's true. If you will look in the <a href="https://github.com/torvalds/linux/blob/master/kernel/cgroup/cpuset.c">kernel/cgroup/cpuset.c</a> source code file, you will see this definition:</p>
<pre><code class="language-C">struct cgroup_subsys cpuset_cgrp_subsys = {
    ...
    ...
    ...
	.early_init	= true,
};
</code></pre>
<p>So the last step in the <code>cgroup_init_early</code> function is initialization of early subsystems with the call of the <code>cgroup_init_subsys</code> function. Following early subsystems will be initialized:</p>
<ul>
<li><code>cpuset</code>;</li>
<li><code>cpu</code>;</li>
<li><code>cpuacct</code>.</li>
</ul>
<p>The <code>cgroup_init_subsys</code> function does initialization of the given subsystem with the default values. For example sets root of hierarchy, allocates space for the given subsystem with the call of the <code>css_alloc</code> callback function, link a subsystem with a parent if it exists, add allocated subsystem to the initial process and etc.</p>
<p>That's all. From this moment early subsystems are initialized.</p>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>It is the end of the first part which describes introduction into <code>Control groups</code> mechanism in the Linux kernel. We covered some theory and the first steps of initialization of stuffs related to <code>control groups</code> mechanism. In the next part we will continue to dive into the more practical aspects of <code>control groups</code>.</p>
<p>If you have any questions or suggestions write me a comment or ping me at <a href="https://twitter.com/0xAX">twitter</a>.</p>
<p><strong>Please note that English is not my first language, And I am really sorry for any inconvenience. If you find any mistakes please send me a PR to <a href="https://github.com/0xAX/linux-insides">linux-insides</a>.</strong></p>
<h2 id="links"><a class="header" href="#links">Links</a></h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Cgroups">control groups</a></li>
<li><a href="https://en.wikipedia.org/wiki/Process_identifier">PID</a></li>
<li><a href="http://man7.org/linux/man-pages/man7/cpuset.7.html">cpuset</a></li>
<li><a href="https://en.wikipedia.org/wiki/Device_file">block devices</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/vm/hugetlbpage.txt">huge pages</a></li>
<li><a href="https://en.wikipedia.org/wiki/Sysfs">sysfs</a></li>
<li><a href="https://en.wikipedia.org/wiki/Procfs">proc</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/cgroup-v1/cgroups.txt">cgroups kernel documentation</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/cgroup-v2.txt">cgroups v2</a></li>
<li><a href="https://www.gnu.org/software/bash/">bash</a></li>
<li><a href="https://en.wikipedia.org/wiki/Docker_(software)">docker</a></li>
<li><a href="https://en.wikipedia.org/wiki/Perf_(Linux)">perf events</a></li>
<li><a href="https://0xax.gitbook.io/linux-insides/summary/mm/linux-mm-1">Previous chapter</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../Cgroups/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../Concepts/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../Cgroups/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../Concepts/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
